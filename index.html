<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flexportal - Your App Collection</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <!-- Custom CSS -->
    <link href="styles/styles.css" rel="stylesheet" />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <!-- Google Fonts -->
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg fixed-top">
      <div class="container-fluid">
        <a class="navbar-brand" href="#">
          <img
            src="https://forum.obsidian.md/uploads/default/original/2X/6/6df43bc4ee96f0a1b67ff3600caf6879b758a743.png"
            alt="Flexportal Logo"
          />
          Flexportal
        </a>

        <!-- Mobile Navigation -->
        <div class="mobile-nav">
          <div class="favorites-mobile">
            <button class="btn btn-favorite" id="favoritesBtn">
              <i class="fas fa-star"></i>
              <span class="favorite-count"></span>
            </button>
          </div>
          <button class="navbar-toggler" type="button" id="sidebarToggle">
            <div class="hamburger-icon">
              <span></span>
              <span></span>
              <span></span>
            </div>
          </button>
        </div>

        <!-- Desktop Navigation -->
        <div class="navbar-collapse" id="navbarContent">
          <ul class="navbar-nav category-nav">
            <li class="nav-item">
              <a class="nav-link active" href="#" data-category="all">All</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-category="games">Games</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-category="school">School</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-category="productivity"
                >Productivity</a
              >
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-category="business">Business</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#" data-category="ai-tools">AI Tools</a>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                role="button"
                data-bs-toggle="dropdown"
              >
                Pricing
              </a>
              <ul class="dropdown-menu">
                <li>
                  <a class="dropdown-item" href="#" data-pricing="all-pricing"
                    >All Pricing</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#" data-pricing="full-free"
                    >Full Free</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#" data-pricing="free-credits"
                    >Free with daily credits</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#" data-pricing="free-limits"
                    >Free with daily limits</a
                  >
                </li>
                <li>
                  <a class="dropdown-item" href="#" data-pricing="paid">Paid</a>
                </li>
              </ul>
            </li>
          </ul>

          <div class="navbar-nav ms-auto">
            <div class="favorites-desktop">
              <button class="btn btn-favorite" id="favoritesBtnDesktop">
                <i class="fas fa-star"></i>
                <span class="favorite-count"></span>
              </button>
              <div class="favorites-dropdown">
                <div class="favorites-list"></div>
              </div>
            </div>
            <button class="btn btn-help" id="helpBtn">
              <i class="fas fa-question-circle"></i>
            </button>
          </div>
        </div>
      </div>
    </nav>

    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-content">
        <!-- Mobile menu items will be inserted here -->
      </div>
    </div>

    <!-- Main Content -->
    <main>
      <!-- Hero Section -->
      <div class="hero-section">
        <div class="search-container">
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search apps..." />
            <button id="searchBtn">
              <i class="fas fa-search"></i>
            </button>
          </div>
          <div class="search-suggestions"></div>
        </div>
      </div>

      <!-- Apps Grid -->
      <div class="apps-container">
        <div class="apps-grid" id="appsGrid"></div>
        <div class="no-apps-found hidden">
          <img
            src="https://cdni.iconscout.com/illustration/premium/thumb/no-address-found-illustration-download-in-svg-png-gif-file-formats--location-app-finding-permission-empty-states-pack-design-development-illustrations-3363925.png?f=webp"
            alt="No apps found"
          />
          <p>Apps belum ada ya, mass mbakk.. segera saya Update, yaa..</p>
        </div>
      </div>
    </main>

    <!-- Floating Feedback Button -->
    <button class="floating-feedback" id="feedbackBtn">
      <i class="fas fa-comment-dots"></i>
    </button>

    <!-- Modals -->
    <!-- Help Modal -->
    <div class="modal fade" id="helpModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">How to Use Flexportal</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="guide-steps">
              <div class="guide-step">
                <i class="fas fa-search"></i>
                <h6>Search or Browse</h6>
                <p>Use the search bar or browse categories to find apps</p>
              </div>
              <div class="guide-step">
                <i class="fas fa-star"></i>
                <h6>Save Favorites</h6>
                <p>Click the three dots menu and select "Add to favorites"</p>
              </div>
              <div class="guide-step">
                <i class="fas fa-external-link-alt"></i>
                <h6>Launch Apps</h6>
                <p>
                  Click on any app card or use the play button to open the app
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Feedback Modal -->
    <div class="modal fade" id="feedbackModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Send Feedback</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <form id="feedbackForm">
              <div class="mb-3">
                <label for="name" class="form-label">Name</label>
                <input type="text" class="form-control" id="name" required />
              </div>
              <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" required />
              </div>
              <div class="mb-3">
                <label for="message" class="form-label">Message</label>
                <textarea
                  class="form-control"
                  id="message"
                  rows="4"
                  required
                ></textarea>
              </div>
              <button type="submit" class="btn btn-primary">
                Send Feedback
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- First Visit Guide -->
    <div class="guide-overlay hidden">
      <div class="guide-card">
        <div class="guide-content">
          <h5>Welcome to Flexportal!</h5>
          <div class="guide-features">
            <div class="feature">
              <i class="fas fa-star"></i>
              <p>Add your favorite apps to quick access</p>
            </div>
            <div class="feature">
              <i class="fas fa-comment-dots"></i>
              <p>Request new apps or give us feedback</p>
            </div>
          </div>
          <button class="btn btn-primary" id="guideCloseBtn">Got it!</button>
        </div>
      </div>
    </div>

    <!-- Required Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="./js/supabase-config.js">
  import { initSupabase } from "./js/supabase-config.js";
  
  // Global variables
  let apps = [];
  const supabase = initSupabase();
  
  // Load apps function
  async function loadApps() {
    try {
      const data = await supabase.queries.getAllApps();
      if (data && data.length > 0) {
        apps = data;
        filterApps();
      } else {
        showNoAppsMessage();
      }
    } catch (error) {
      console.error("Failed to load apps:", error);
      showErrorMessage("Failed to load apps");
    }
  }

  // Initialize after DOM is ready
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      await loadApps();
      updateFavoritesList();
      checkFirstVisit();
    } catch (error) {
      console.error("Initialization error:", error);
    }
  });
    </script>
    <script>
      // App state
      let currentCategory = "all";
      let currentPricing = null;
      let favorites = JSON.parse(localStorage.getItem("favorites")) || [];

      // DOM Elements
      const searchInput = document.getElementById("searchInput");
      const searchBtn = document.getElementById("searchBtn");
      const appsGrid = document.getElementById("appsGrid");
      const noAppsFound = document.querySelector(".no-apps-found");
      const favoritesDropdown = document.querySelector(".favorites-dropdown");
      const favoritesList = document.querySelector(".favorites-list");
      const favCountElements = document.querySelectorAll(".favorite-count");
      const navbar = document.querySelector(".navbar");
      const hamburgerBtn = document.querySelector(".navbar-toggler");
      const hamburgerBtnMobile = document.getElementById("sidebarToggle");
      const hamburgerIcon = hamburgerBtnMobile.querySelector(".hamburger-icon");
      const sidebar = document.querySelector(".sidebar");

      // Event Listeners
      document.addEventListener("DOMContentLoaded", async () => {
        await loadApps();
        updateFavoritesList();
        checkFirstVisit();

        // Initialize all tooltips
        const tooltipTriggerList = [].slice.call(
          document.querySelectorAll('[data-bs-toggle="tooltip"]')
        );
        tooltipTriggerList.map(
          (tooltipTriggerEl) => new bootstrap.Tooltip(tooltipTriggerEl)
        );
      });

      // Fungsi untuk memperbarui tautan navigasi aktif
      function updateActiveNavLink(target) {
        document
          .querySelectorAll(".nav-link[data-category]")
          .forEach((link) => {
            link.classList.remove("active");
          });
        target.classList.add("active");
      }

      // Category navigation
      document.querySelectorAll(".nav-link[data-category]").forEach((link) => {
        link.addEventListener("click", (e) => {
          e.preventDefault();
          currentCategory = e.target.dataset.category;
          updateActiveNavLink(e.target);
          filterApps();
        });
      });

      // Pricing filters
      document
        .querySelectorAll(".dropdown-item[data-pricing]")
        .forEach((item) => {
          item.addEventListener("click", (e) => {
            e.preventDefault();
            currentPricing =
              e.target.dataset.pricing === "all-pricing"
                ? null
                : e.target.dataset.pricing;
            updateActiveNavLink(e.target); // Update active link
            filterApps();
          });
        });

      // Search functionality
      searchInput.addEventListener("input", debounce(handleSearch, 300));
      searchBtn.addEventListener("click", () => handleSearch());
      searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") handleSearch();
      });

      // // Mobile navigation
      hamburgerBtnMobile.addEventListener("click", toggleSidebar);
      document.addEventListener("click", (e) => {
        if (
          !sidebar.contains(e.target) &&
          !hamburgerBtnMobile.contains(e.target)
        ) {
          sidebar.classList.remove("active");
          hamburgerIcon.classList.remove("active");
        }
      });

      // Modals
      document.getElementById("helpBtn").addEventListener("click", () => {
        new bootstrap.Modal(document.getElementById("helpModal")).show();
      });

      document.getElementById("feedbackBtn").addEventListener("click", () => {
        new bootstrap.Modal(document.getElementById("feedbackModal")).show();
      });

      document
        .getElementById("feedbackForm")
        .addEventListener("submit", handleFeedbackSubmit);

      // Functions

      async function loadApps() {
        try {
          const { data, error } = await supabase.from("apps").select("*");

          if (error) throw error;

          apps = data;
          filterApps();
        } catch (error) {
          console.error("Error loading apps:", error);
          showErrorMessage("Failed to load apps");
        }
      }

      function filterApps() {
        let filteredApps = [...apps];

        if (currentCategory !== "all") {
          filteredApps = filteredApps.filter(
            (app) => app.category === currentCategory
          );
        }

        if (currentPricing && currentPricing !== "all-pricing") {
          filteredApps = filteredApps.filter(
            (app) => app.pricing === currentPricing
          );
        }

        renderApps(filteredApps);
      }

      function renderApps(appsToRender) {
        appsGrid.innerHTML = "";

        if (appsToRender.length === 0) {
          noAppsFound.classList.remove("hidden");
          return;
        }

        noAppsFound.classList.add("hidden");

        appsToRender.forEach((app) => {
          const card = createAppCard(app);
          appsGrid.appendChild(card);
        });
      }

      function createAppCard(app) {
        const card = document.createElement("div");
        card.className = "app-card";

        const thumbnailsHtml = app.thumbnails
          .map(
            (url, index) => `
            <div class="thumbnail ${
              index === 0 ? "active" : ""
            }" style="background-image: url('${url}')"></div>
        `
          )
          .join("");

        card.innerHTML = `
        <div class="thumbnails-container">
            ${thumbnailsHtml}
        </div>
        <div class="card-content">
            <h3>${app.name}</h3>
            <p>${app.description}</p>
            <div class="card-footer">
                <span class="pricing-label ${app.pricing}">${formatPricing(
          app.pricing
        )}</span>
                <div class="dropdown">
                    <button class="btn btn-icon" data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li>
                            <a class="dropdown-item" href="${
                              app.link
                            }" target="_blank">
                                <i class="fas fa-play"></i> Play
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item preview-btn" href="#" data-thumbnails='${JSON.stringify(
                              app.thumbnails
                            )}'>
                                <i class="fas fa-eye"></i> Preview
                            </a>
                        </li>
                        <li>
                            <a class="dropdown-item ${
                              isInFavorites(app.id) ? "active" : ""
                            }" href="#" data-app='${JSON.stringify(app)}'>
                                <i class="fas fa-star"></i> ${
                                  isInFavorites(app.id)
                                    ? "Remove from"
                                    : "Add to"
                                } Favorites
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    `;

        // Event listener untuk keseluruhan card
        card.addEventListener("click", (event) => {
          // Cek jika target klik bukan bagian dari dropdown
          const isDropdownClick =
            event.target.closest(".dropdown") ||
            event.target.closest(".dropdown-menu");
          if (!isDropdownClick) {
            window.open(app.link, "_blank");
          }
        });

        // Set up thumbnail rotation
        const thumbnails = card.querySelectorAll(".thumbnail");
        let currentIndex = 0;

        if (thumbnails.length > 1) {
          setInterval(() => {
            thumbnails[currentIndex].classList.remove("active");
            currentIndex = (currentIndex + 1) % thumbnails.length;
            thumbnails[currentIndex].classList.add("active");
          }, 3000);
        }

        // Tambahkan di akhir fungsi createAppCard
        card
          .querySelector(".dropdown-item[data-app]")
          .addEventListener("click", function (event) {
            event.preventDefault();
            const appData = JSON.parse(this.dataset.app);
            toggleFavorite(event, appData);
          });

        return card;
      }

      function formatPricing(pricing) {
        return pricing
          .split("-")
          .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
          .join(" ");
      }

      function isInFavorites(appId) {
        return favorites.some((fav) => fav.id === appId);
      }

      function toggleFavorite(event, app) {
        event.preventDefault();

        const index = favorites.findIndex((fav) => fav.id === app.id);

        if (index === -1) {
          favorites.push(app);
        } else {
          favorites.splice(index, 1);
        }

        localStorage.setItem("favorites", JSON.stringify(favorites));
        updateFavoritesList();
        filterApps(); // Refresh cards to update favorite status
      }

      function updateFavoritesList() {
        // Update favorite count
        const count = favorites.length;
        favCountElements.forEach((element) => {
          element.textContent = count > 0 ? count : "";
          element.classList.toggle("has-favorites", count > 0);
        });

        // Update dropdown list
        if (favorites.length === 0) {
          favoritesList.innerHTML = `
      <div class="empty-favorites">
        <i class="fas fa-star"></i>
        <p>No favorites yet</p>
      </div>
    `;
          return;
        }

        favoritesList.innerHTML = favorites
          .map(
            (app) => `
        <div class="favorite-item">
          <img src="${app.icon}" alt="${app.name}">
          <a href="${app.link}" target="_blank">${app.name}</a>
          <button class="btn btn-icon remove-favorite" data-app='${JSON.stringify(
            app
          )}'>
            <i class="fas fa-times"></i>
          </button>
        </div>
      `
          )
          .join("");

        // Add event listeners for remove buttons
        document.querySelectorAll(".remove-favorite").forEach((btn) => {
          btn.addEventListener("click", function (event) {
            event.stopPropagation(); // Prevent the event from bubbling up to the document
            const appData = JSON.parse(this.dataset.app);
            toggleFavorite(event, appData);
          });
        });
      }

      // Fungsi untuk toggle favorites dropdown
      function toggleFavoritesDropdown(event) {
        event.stopPropagation();
        favoritesDropdown.classList.toggle("show");

        // Close dropdown when clicking outside
        if (favoritesDropdown.classList.contains("show")) {
          document.addEventListener("click", closeFavoritesDropdown);
        } else {
          document.removeEventListener("click", closeFavoritesDropdown);
        }
      }

      // Fungsi untuk menutup favorites dropdown
      function closeFavoritesDropdown(event) {
        if (
          !favoritesDropdown.contains(event.target) &&
          !event.target.closest(".btn-favorite")
        ) {
          favoritesDropdown.classList.remove("show");
          document.removeEventListener("click", closeFavoritesDropdown);
        }
      }

      // Event listener untuk tombol favorite
      document.querySelectorAll(".btn-favorite").forEach((btn) => {
        btn.addEventListener("click", toggleFavoritesDropdown);
      });

      // Pastikan event listener untuk menutup dropdown ditambahkan dengan benar
      document.addEventListener("click", closeFavoritesDropdown);

      // Sidebar navigation
      document.addEventListener("DOMContentLoaded", () => {
        const sidebarContent = document.querySelector(".sidebar-content");
        const navbarMenu = document.querySelector(".navbar-collapse");

        if (sidebarContent && navbarMenu) {
          // Clone menu dari navbar ke sidebar
          sidebarContent.innerHTML = navbarMenu.innerHTML;

          // Tambahkan event listener untuk navigasi di sidebar
          sidebarContent.querySelectorAll(".nav-link").forEach((link) => {
            link.addEventListener("click", (e) => {
              e.preventDefault();
              const category = e.target.dataset.category || "all";
              currentCategory = category;
              updateActiveNavLink(e.target);
              filterApps();

              // Jika bukan dropdown, tutup sidebar
              if (!e.target.closest(".dropdown-toggle")) {
                closeSidebar();
              }
            });
          });

          // Tambahkan event listener untuk dropdown di sidebar
          sidebarContent.querySelectorAll(".dropdown-item").forEach((item) => {
            item.addEventListener("click", (e) => {
              e.preventDefault();
              const pricing = e.target.dataset.pricing;
              currentPricing = pricing;
              filterApps();
              closeSidebar();
            });
          });
        }
      });

      // Fungsi untuk menutup favorites dropdown
      // function closeFavoritesDropdown(event) {
      //   if (
      //     !favoritesDropdown.contains(event.target) &&
      //     !event.target.closest(".btn-favorite")
      //   ) {
      //     favoritesDropdown.classList.remove("show");
      //     document.removeEventListener("click", closeFavoritesDropdown);
      //   }
      // }

      // Fungsi untuk menangani toggle sidebar yang diperbaiki
      function toggleSidebar() {
        const sidebarContent = sidebar.querySelector(".sidebar-content");

        // Jika sidebar belum memiliki konten, tambahkan konten
        if (sidebarContent.children.length === 0) {
          // Clone navigation items
          const navItems = document
            .querySelector(".category-nav")
            .cloneNode(true);
          sidebarContent.appendChild(navItems);

          // Add event listeners to sidebar nav links
          sidebarContent
            .querySelectorAll(".nav-link[data-category]")
            .forEach((link) => {
              link.addEventListener("click", (e) => {
                e.preventDefault();

                // Update current category
                currentCategory = e.target.dataset.category;

                // Update active states di sidebar dan navbar
                updateActiveNavLinks(currentCategory);

                // Filter apps berdasarkan kategori
                filterApps();

                // Tutup sidebar
                closeSidebar();
              });
            });
        }

        // Toggle sidebar dan hamburger icon
        sidebar.classList.toggle("active");
        hamburgerIcon.classList.toggle("active");
      }

      // Fungsi untuk update active state pada semua nav links
      function updateActiveNavLinks(category) {
        // Update di navbar desktop
        document
          .querySelectorAll(".navbar .nav-link[data-category]")
          .forEach((link) => {
            if (link.dataset.category === category) {
              link.classList.add("active");
            } else {
              link.classList.remove("active");
            }
          });

        // Update di sidebar mobile
        document
          .querySelectorAll(".sidebar .nav-link[data-category]")
          .forEach((link) => {
            if (link.dataset.category === category) {
              link.classList.add("active");
            } else {
              link.classList.remove("active");
            }
          });
      }

      // Event listener untuk hamburger button
      hamburgerBtnMobile.addEventListener("click", function (e) {
        e.preventDefault();
        toggleSidebar();
      });

      document.addEventListener("click", function (event) {
        if (
          sidebar.classList.contains("active") &&
          !sidebar.contains(event.target) &&
          !hamburgerBtnMobile.contains(event.target)
        ) {
          closeSidebar();
        }
      });

      // Update fungsi closeSidebar agar lebih seragam
      function closeSidebar() {
        // Toggle sidebar dan hamburger icon
        sidebar.classList.toggle("active");
        hamburgerIcon.classList.toggle("active");
      }

      // Update kategori navigasi di navbar desktop
      document
        .querySelectorAll(".navbar .nav-link[data-category]")
        .forEach((link) => {
          link.addEventListener("click", (e) => {
            e.preventDefault();
            currentCategory = e.target.dataset.category;
            updateActiveNavLinks(currentCategory);
            filterApps();
          });
        });

      async function handleSearch() {
        const searchTerm = searchInput.value.toLowerCase().trim();

        if (!searchTerm) {
          filterApps();
          return;
        }

        const filteredApps = apps.filter(
          (app) =>
            app.name.toLowerCase().includes(searchTerm) ||
            app.description.toLowerCase().includes(searchTerm)
        );

        renderApps(filteredApps);
      }

      // Tambahkan fungsi baru untuk handle mobile favorites
      function handleMobileFavorites(event) {
        event.preventDefault();
        event.stopPropagation();

        const mobileDropdown = document.createElement("div");
        mobileDropdown.className = "favorites-dropdown mobile show";
        mobileDropdown.innerHTML = `
    <div class="favorites-list">
      ${
        favorites.length === 0
          ? `
          <div class="empty-favorites">
            <i class="fas fa-star"></i>
            <p>No favorites yet</p>
          </div>
        `
          : favorites
              .map(
                (app) => `
          <div class="favorite-item">
            <img src="${app.icon}" alt="${app.name}">
            <a href="${app.link}" target="_blank">${app.name}</a>
            <button class="btn btn-icon remove-favorite" data-app='${JSON.stringify(
              app
            )}'>
              <i class="fas fa-times"></i>
            </button>
          </div>
        `
              )
              .join("")
      }
    </div>
  `;

        // Dapatkan referensi ke container favorites-mobile
        const mobileContainer = document.querySelector(".favorites-mobile");

        // Hapus dropdown yang sudah ada jika ada
        const existingDropdown = mobileContainer.querySelector(
          ".favorites-dropdown.mobile"
        );
        if (existingDropdown) {
          existingDropdown.classList.remove("show");
          setTimeout(() => existingDropdown.remove(), 300); // Memberikan waktu untuk animasi
        } else {
          // Tambahkan dropdown baru ke dalam container
          mobileContainer.appendChild(mobileDropdown);

          // Trigger reflow dan tambahkan class show
          setTimeout(() => mobileDropdown.classList.add("show"), 10);

          // Add event listeners untuk tombol remove
          mobileDropdown
            .querySelectorAll(".btn-icon.remove-favorite")
            .forEach((btn) => {
              btn.addEventListener("click", function (e) {
                e.stopPropagation(); // Prevent the event from bubbling up to the document
                const appData = JSON.parse(this.dataset.app);
                toggleFavorite(e, appData);
                mobileDropdown.classList.remove("show");
                setTimeout(() => mobileDropdown.remove(), 300);
              });
            });

          function closeDropdown(event) {
            const mobileDropdown = document.querySelector(
              ".favorites-dropdown.mobile"
            );

            // Pastikan mobileDropdown ada sebelum memproses
            if (!mobileDropdown) {
              document.removeEventListener("click", closeDropdown);
              return;
            }

            if (
              !mobileDropdown.contains(event.target) &&
              !document
                .querySelector(".favorites-mobile")
                .contains(event.target)
            ) {
              mobileDropdown.classList.remove("show");
              setTimeout(() => {
                mobileDropdown.remove();
                document.removeEventListener("click", closeDropdown);
              }, 300);
            }
          }

          document.addEventListener("click", closeDropdown);
        }
      }

      // Tambahkan event listener untuk tombol favorite mobile
      document
        .querySelector(".favorites-mobile .btn-favorite")
        .addEventListener("click", handleMobileFavorites);

      function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
          const later = () => {
            clearTimeout(timeout);
            func(...args);
          };
          clearTimeout(timeout);
          timeout = setTimeout(later, wait);
        };
      }

      async function handleFeedbackSubmit(e) {
        e.preventDefault();

        const formData = {
          name: document.getElementById("name").value,
          email: document.getElementById("email").value,
          message: document.getElementById("message").value,
        };

        // Simple email sending using mailto
        const mailtoLink = `mailto:akunshopeepertama12@gmail.com?subject=Flexportal Feedback from ${
          formData.name
        }&body=${encodeURIComponent(formData.message)}%0D%0A%0D%0AFrom: ${
          formData.name
        }%0D%0AEmail: ${formData.email}`;
        window.location.href = mailtoLink;

        // Close modal
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("feedbackModal")
        );
        modal.hide();

        // Reset form
        e.target.reset();
      }

      function checkFirstVisit() {
        if (!localStorage.getItem("hasVisited")) {
          document.querySelector(".guide-overlay").classList.remove("hidden");
          localStorage.setItem("hasVisited", "true");

          document
            .getElementById("guideCloseBtn")
            .addEventListener("click", () => {
              document.querySelector(".guide-overlay").classList.add("hidden");
            });
        }
      }

      document
        .getElementById("sidebarToggle")
        .addEventListener("click", function () {
          const sidebar = document.querySelector(".sidebar");
          const hamburger = this.querySelector(".hamburger-icon");
          sidebar.classList.toggle("active");
          hamburger.classList.toggle("active");
        });

      // Fix feedback button
      document
        .getElementById("feedbackBtn")
        .addEventListener("click", function () {
          const feedbackModal = new bootstrap.Modal(
            document.getElementById("feedbackModal")
          );
          feedbackModal.show();
        });

      document
        .getElementById("feedbackModal")
        .addEventListener("hidden.bs.modal", () => {
          const backdrop = document.querySelector(".modal-backdrop");
          if (backdrop) {
            backdrop.remove();
          }
        });

      // Fix first visit guide
      document.addEventListener("DOMContentLoaded", function () {
        // Check if it's first visit
        if (!localStorage.getItem("hasVisited")) {
          // Show guide
          document.querySelector(".guide-overlay").classList.remove("hidden");

          // Add event listener to close button
          document
            .getElementById("guideCloseBtn")
            .addEventListener("click", function () {
              document.querySelector(".guide-overlay").classList.add("hidden");
              localStorage.setItem("hasVisited", "true");
            });
        }
      });

      function showErrorMessage(message) {
        // You can implement a toast or alert system here
        console.error(message);
      }
    </script>
  </body>
</html>
